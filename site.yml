---

- hosts: all
  sudo: yes
  vars:
    citadel_bucket: 'balanced-citadel'
    rabbitmq_vhosts:
      - localhost
    redis_bind:
      - 127.0.0.1

  vars_files:
    - roles/elasticsearch/vars/sample.yml
    - 'defaults/main.yml'

  roles:
    - base
    - elasticsearch
    - postgresql
    - rabbitmq
    - redis

  handlers:
    - include: handlers/main.yml

  tasks:
    - name: Fetch deploy key?
      debug: msg="{{ lookup('citadel', '/deploy_key/deploy.pem') }}"
      tags: citadel

    - name: Write the deploy key for cloning
      tags: deploy-key
      sudo: false
      lineinfile:
        dest=~/.ssh/deploy_key
        line="{{ lookup('citadel', '/deploy_key/deploy.pem') }}"
        state=present
        create=yes
        mode='0400'

    # http://hakunin.com/six-ansible-practices
    - name: ensure github.com is a known host
      tags: balanced-install
      lineinfile:
        dest: /root/.ssh/known_hosts
        create: yes
        state: present
        line: "{{ lookup('pipe', 'ssh-keyscan -t rsa github.com') }}"
        regexp: "^github\\.com"

    - name: install balanced
      sudo: no
      include: tasks/main.yml
      tags: balanced-install
      vars:
        balanced_install_method: apt
        balanced_apt_version: null
